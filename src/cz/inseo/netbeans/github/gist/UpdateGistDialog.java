
package cz.inseo.netbeans.github.gist;

import cz.inseo.netbeans.github.GitHubAuth;
import cz.inseo.netbeans.github.options.GitHubOptions;
import cz.inseo.netbeans.github.tools.InfoDialog;
import java.awt.Cursor;
import java.awt.Point;
import java.io.IOException;
import java.util.Collections;
import javax.swing.SwingUtilities;
import org.eclipse.egit.github.core.Gist;
import org.eclipse.egit.github.core.GistFile;
import org.eclipse.egit.github.core.client.RequestException;
import org.eclipse.egit.github.core.service.GistService;
import org.openide.util.Exceptions;
import org.openide.util.RequestProcessor;

/**
 *
 * @author junichi11
 */
public class UpdateGistDialog extends java.awt.Dialog {

        private String gistId = "";
                
	public UpdateGistDialog(java.awt.Frame parent, boolean modal) {
		super(parent, modal);
		initComponents();
		loadSetting();
	}

	private void loadSetting() {
                
		String login = GitHubOptions.getInstance().getLogin();

		if (login != null && !login.equals("")) {
			logedRadio.setVisible(true);
			logedRadio.setText(login);
			logedRadio.setSelected(true);
		} else {
                        InfoDialog.showInfo("Please Login");
		}
	}

	public void setFile(String fileName, String content, String mimeType, String gistId) {
		fileNameText.setText(fileName);
		editorPane.setContentType(mimeType);
		editorPane.setText(content);
                this.gistId = gistId;
                GistService gistService = GitHubAuth.getGistService(true);
                try {
                        descriptionText.setText(gistService.getGist(gistId).getDescription());
                } catch (IOException ex) {
                        Exceptions.printStackTrace(ex);
                }
	}

	private Gist buildGist() {
		Gist gist = new Gist();
                gist.setId(gistId);
		gist.setDescription(descriptionText.getText());
		if (logedRadio.isSelected()) {
			//	gist.setUser(GitHubAuth.getUserService());
		}

		GistFile file = new GistFile().setContent(editorPane.getText());
		gist.setFiles(Collections.singletonMap(fileNameText.getText(), file));

		return gist;
	}

	private void createdDialog(final String url) {
		final Point m_location = getLocation();
		RequestProcessor.getDefault().execute(new Runnable() {

			@Override
			public void run() {

				SwingUtilities.invokeLater(new Runnable() {

					@Override
					public void run() {
						CreatedDialog createdDialog = new CreatedDialog(null, true);
						createdDialog.urlText.setText(url);
						createdDialog.setLocation(m_location);						
						createdDialog.setFocusableWindowState(true);
						createdDialog.setVisible(true);
					}
				});
			}
		});
	}
	
	/** This method is called from within the constructor to
	 * initialize the form.
	 * WARNING: Do NOT modify this code. The content of this method is
	 * always regenerated by the Form Editor.
	 */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        userRadioGroup = new javax.swing.ButtonGroup();
        dialogPane = new javax.swing.JPanel();
        filePane = new javax.swing.JPanel();
        fileNameText = new javax.swing.JTextField();
        fileNameLabel = new javax.swing.JLabel();
        userLabel = new javax.swing.JLabel();
        logedRadio = new javax.swing.JRadioButton();
        fileScrollPane = new javax.swing.JScrollPane();
        editorPane = new javax.swing.JEditorPane();
        addFileButton = new javax.swing.JButton();
        saveButton = new javax.swing.JButton();
        descriptionPane = new javax.swing.JPanel();
        descriptionLabel = new javax.swing.JLabel();
        descriptionText = new javax.swing.JTextField();
        descriptionSeparator = new javax.swing.JSeparator();

        setMinimumSize(new java.awt.Dimension(720, 510));
        setTitle(org.openide.util.NbBundle.getMessage(UpdateGistDialog.class, "UpdateGistDialog.title")); // NOI18N
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowClosing(java.awt.event.WindowEvent evt) {
                closeDialog(evt);
            }
        });

        fileNameLabel.setText(org.openide.util.NbBundle.getMessage(UpdateGistDialog.class, "UpdateGistDialog.fileNameLabel.text")); // NOI18N

        userLabel.setText(org.openide.util.NbBundle.getMessage(UpdateGistDialog.class, "UpdateGistDialog.userLabel.text")); // NOI18N

        userRadioGroup.add(logedRadio);
        logedRadio.setText(org.openide.util.NbBundle.getMessage(UpdateGistDialog.class, "UpdateGistDialog.logedRadio.text")); // NOI18N

        editorPane.setText(org.openide.util.NbBundle.getMessage(UpdateGistDialog.class, "UpdateGistDialog.editorPane.text")); // NOI18N
        fileScrollPane.setViewportView(editorPane);

        addFileButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/cz/inseo/netbeans/github/resources/images/new_file.png"))); // NOI18N
        addFileButton.setText(org.openide.util.NbBundle.getMessage(UpdateGistDialog.class, "UpdateGistDialog.addFileButton.text")); // NOI18N
        addFileButton.setEnabled(false);
        addFileButton.setIconTextGap(8);
        addFileButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                addFileButtonActionPerformed(evt);
            }
        });

        saveButton.setText(org.openide.util.NbBundle.getMessage(UpdateGistDialog.class, "UpdateGistDialog.saveButton.text")); // NOI18N
        saveButton.setIconTextGap(8);
        saveButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                saveButtonActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout filePaneLayout = new javax.swing.GroupLayout(filePane);
        filePane.setLayout(filePaneLayout);
        filePaneLayout.setHorizontalGroup(
            filePaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, filePaneLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(filePaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addGroup(javax.swing.GroupLayout.Alignment.LEADING, filePaneLayout.createSequentialGroup()
                        .addGroup(filePaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(fileNameLabel)
                            .addComponent(userLabel))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addGroup(filePaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(fileNameText, javax.swing.GroupLayout.PREFERRED_SIZE, 233, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(logedRadio)))
                    .addGroup(filePaneLayout.createSequentialGroup()
                        .addComponent(addFileButton)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(saveButton))
                    .addComponent(fileScrollPane, javax.swing.GroupLayout.Alignment.LEADING))
                .addContainerGap())
        );
        filePaneLayout.setVerticalGroup(
            filePaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, filePaneLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(filePaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(fileNameLabel)
                    .addComponent(fileNameText, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(filePaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(logedRadio)
                    .addComponent(userLabel))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(fileScrollPane, javax.swing.GroupLayout.DEFAULT_SIZE, 315, Short.MAX_VALUE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(filePaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(saveButton, javax.swing.GroupLayout.PREFERRED_SIZE, 34, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(addFileButton, javax.swing.GroupLayout.PREFERRED_SIZE, 34, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap())
        );

        descriptionLabel.setText(org.openide.util.NbBundle.getMessage(UpdateGistDialog.class, "UpdateGistDialog.descriptionLabel.text")); // NOI18N

        javax.swing.GroupLayout descriptionPaneLayout = new javax.swing.GroupLayout(descriptionPane);
        descriptionPane.setLayout(descriptionPaneLayout);
        descriptionPaneLayout.setHorizontalGroup(
            descriptionPaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(descriptionPaneLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(descriptionLabel)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(descriptionText, javax.swing.GroupLayout.PREFERRED_SIZE, 549, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
            .addComponent(descriptionSeparator)
        );
        descriptionPaneLayout.setVerticalGroup(
            descriptionPaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(descriptionPaneLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(descriptionPaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(descriptionLabel)
                    .addComponent(descriptionText, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 14, Short.MAX_VALUE)
                .addComponent(descriptionSeparator, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
        );

        javax.swing.GroupLayout dialogPaneLayout = new javax.swing.GroupLayout(dialogPane);
        dialogPane.setLayout(dialogPaneLayout);
        dialogPaneLayout.setHorizontalGroup(
            dialogPaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(descriptionPane, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addGroup(dialogPaneLayout.createSequentialGroup()
                .addComponent(filePane, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );
        dialogPaneLayout.setVerticalGroup(
            dialogPaneLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(dialogPaneLayout.createSequentialGroup()
                .addContainerGap()
                .addComponent(descriptionPane, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(filePane, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addContainerGap())
        );

        add(dialogPane, java.awt.BorderLayout.CENTER);

        pack();
    }// </editor-fold>//GEN-END:initComponents

	/** Closes the dialog */
    private void closeDialog(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_closeDialog
		setVisible(false);
		dispose();
    }//GEN-LAST:event_closeDialog

	private void addFileButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_addFileButtonActionPerformed
		//Gist gist = buildGist();
		//add to explorer & close
}//GEN-LAST:event_addFileButtonActionPerformed

	private void saveButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_saveButtonActionPerformed
		Gist gist = buildGist();
		gist.setPublic(true);
		try {
			setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));
			Gist updateGist = GitHubAuth.getGistService(true).updateGist(gist);
			createdDialog(updateGist.getHtmlUrl());
			closeDialog(null);
		} catch (RequestException ex) {
			GitHubAuth.processException(ex);
		} catch (IOException ex) {
			Exceptions.printStackTrace(ex);
		}finally{
			setCursor(Cursor.getPredefinedCursor(Cursor.DEFAULT_CURSOR));
		}
}//GEN-LAST:event_saveButtonActionPerformed

	/**
	 * @param args the command line arguments
	 */
	public static void main(String args[]) {
		java.awt.EventQueue.invokeLater(new Runnable() {

			@Override
			public void run() {
				UpdateGistDialog dialog = new UpdateGistDialog(new java.awt.Frame(), true);
				dialog.addWindowListener(new java.awt.event.WindowAdapter() {

					@Override
					public void windowClosing(java.awt.event.WindowEvent e) {
						System.exit(0);
					}
				});
				dialog.setVisible(true);
			}
		});
	}
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton addFileButton;
    private javax.swing.JLabel descriptionLabel;
    private javax.swing.JPanel descriptionPane;
    private javax.swing.JSeparator descriptionSeparator;
    private javax.swing.JTextField descriptionText;
    private javax.swing.JPanel dialogPane;
    private javax.swing.JEditorPane editorPane;
    private javax.swing.JLabel fileNameLabel;
    private javax.swing.JTextField fileNameText;
    private javax.swing.JPanel filePane;
    private javax.swing.JScrollPane fileScrollPane;
    private javax.swing.JRadioButton logedRadio;
    private javax.swing.JButton saveButton;
    private javax.swing.JLabel userLabel;
    private javax.swing.ButtonGroup userRadioGroup;
    // End of variables declaration//GEN-END:variables
}
